
<style>
    .servo {
        margin-block: 10px;
    }
    .result-text {
        margin-left: 10px;
        font-size: 1rem;
    }
    .danger {
        color: red;
    }
    .success {
        color: green;
    }
    #servos {
        width: 50%;
    }
    #poses {
        width: 50%;
    }
    .row {
        display: flex;
    }
    .row > div, #states {
        border: 1px solid;
        padding: 10px;
    }
    .servo-range {
        margin-left: 80px;
        width: 360px;
    }
</style>
<div class="row">
    <div id="servos">
        <h1>Настройка вручную</h1>
    </div>
    <div id="poses">
        <h1>Готовые позиции</h1>
        <select id="pose-select">
            <option value="0">Стандартная</option>
            <option value="1">Змейка</option>
            <option value="2">Зиг-заг</option>
            <option value="3">Наклон</option>
        </select>
        <button class="form-btn pose-btn">Применить</button>
        <span class="result-text-pose"></span>
    </div>
</div>
<div id="states">
    <h1 class="text-center">Состояние</h1>
    <button class="form-btn state-btn">Тест</button>
</div>
<script>
    var servoForms = {
        servoCount: 6,
        servoMax: 180,
        servoMin: -180,
        init: function() {
            var self = this;

            for (var i = 0; i < this.servoCount; i++) {
                var label = 'Servo ' + (i + 1);
                var name = 'servo' + (i + 1);

                var html = '<div class="' + name + ' servo">';
                html += '<label class="form-label">' + label + '</label>';
                html += '<input type="number" max="180" min="-180" class="form-input servo-input" name="' + name + '"/>';
                html += '<button type="button" class="form-btn servo-btn" data-input="' + name + '">Отправить</button>';
                html += '<input type="range" max="180" min="-180" step="1" class="servo-range" name="' + name + '"/>';
                html += '<span class="result-text" data-servo="' + name + '"></span>';
                html += '</div>';

                $('#servos').append(html);
            }

            $(document).on('click', '.servo-btn', function() {
                var name = $(this).attr('data-input');
                var resultSpan = $('.result-text[data-servo=' + name + ']');
                var input = $('input.servo-input[name=' + name + ']');
                var val = input.val();

                self.clearResult(resultSpan);
                
                if (val && isFinite(val) && val >= self.servoMin && val <= self.servoMax) {
                    $.ajax({
                        method: 'POST',
                        url: '/servo',
                        data: JSON.stringify({angle: val, servo: name.replace('servo', '')}),
                        contentType: 'application/json',
                        success: function(res) {
                            if (res.status == 'ok') {
                                self.showResult(resultSpan, res.response, true);
                            }
                        },
                        error: function(res) {
                            self.showResult(resultSpan, res.responseText, false);
                        }
                    });
                } else {
                    self.showResult(resultSpan, 'Неверное число. Число должно быть в дипаозоне [' + self.servoMin + '; ' + self.servoMax + ']', false);
                }
            });

            $(document).on('click', '.pose-btn', function() {
                var val = $('#pose-select').val();
                var resultSpan = $('.result-text-pose');

                self.clearResult(resultSpan);

                $.ajax({
                        method: 'POST',
                        url: '/pose',
                        data: JSON.stringify({pose: val}),
                        contentType: 'application/json',
                        success: function(res) {
                            if (res.status == 'ok') {
                                self.showResult(resultSpan, 'Success', true);
                                var servos = JSON.parse(res.response);
                                self.updateInputs(servos);
                            }
                        },
                        error: function(res) {
                            self.showResult(resultSpan, res.responseText, false);
                        }
                    });
            });

            $(document).on('click', '.state-btn', function() {
                var val = '32';

                $.ajax({
                        method: 'POST',
                        url: '/state',
                        data: JSON.stringify({state: val}),
                        contentType: 'application/json',
                        success: function(res) {
                            console.log(res);
                        },
                        error: function(res) {
                            console.log(res);
                        }
                    });
            });

            $(document).on('input', '.servo-range', function() {
                var val = $(this).val();
                var name = $(this).attr('name');
                $('input.servo-input[name=' + name + ']').val(val);
                $('.servo-btn[data-input=' + name + ']').trigger('click');
            });

            $(document).on('input', '.servo-input', function() {
                var val = $(this).val();
                var name = $(this).attr('name');
                $('input.servo-range[name=' + name + ']').val(val);
            });
        },
        showResult: function(resultSpan, text, isSuccess) {
            resultSpan.html(text);

            if (!isSuccess) {
                resultSpan.addClass('danger');
            } else {
                resultSpan.addClass('success');
            }
        },
        clearResult: function(resultSpan) {
            resultSpan.html('');
            resultSpan.removeClass('danger');
            resultSpan.removeClass('success');
        },
        updateInputs: function(servos) {
            for (var i = 0; i < servos.length; i++) {
                var servoIdx = i + 1;
                var val = servos[i];
                $('input.servo-input[name=servo' + servoIdx + ']').val(val);
                $('input.servo-range[name=servo' + servoIdx + ']').val(val);
            }
        }
    }
    $(document).ready(function() {
        servoForms.init();
    });
</script>